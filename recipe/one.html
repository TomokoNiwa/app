<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Kitchen Studio ğŸ³</title>
    <style>
        :root { --main-color: #ff9a9e; --sub-color: #fad0c4; --accent: #f093fb; --bg: #fffaf0; --text: #5d4037; --seasoning: #e3f2fd; --danger: #ff6b6b; }
        body { font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        .app-header { background: white; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .app-title { font-size: 1.2rem; color: var(--main-color); font-weight: bold; }
        .menu-icon { display: none; font-size: 1.5rem; cursor: pointer; }
        .header-tools { display: flex; align-items: center; gap: 10px; }
        .page { display: none; padding: 15px; max-width: 1200px; margin: 0 auto; }
        .page.active { display: block; }
        .container { display: flex; gap: 20px; }
        .sidebar { width: 250px; background: white; border-radius: 25px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); height: fit-content; flex-shrink: 0; }
        .cat-title { font-size: 0.8rem; background: var(--sub-color); padding: 4px 12px; border-radius: 15px; display: inline-block; margin: 10px 0 5px; color: #d35400; font-weight: bold; }
        .ing-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .ing-tag { background: #fdf2f2; border: 1px solid #fee2e2; padding: 6px 14px; border-radius: 18px; cursor: pointer; font-size: 0.85rem; }
        .ing-tag.selected { background: var(--main-color); color: white; border-color: var(--main-color); }
        .main-content { flex: 1; min-width: 0; }
        .search-input { width: 100%; padding: 12px 20px; border-radius: 30px; border: 3px solid var(--sub-color); margin-bottom: 20px; box-sizing: border-box; }
        .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .recipe-card { display: flex; align-items: center; background: white; border-radius: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; border-bottom: 3px solid #ddd; height: 80px; overflow: hidden; }
        .recipe-img-box { width: 80px; height: 80px; background: #fff5f5; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .recipe-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .recipe-info { padding: 10px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        @media (max-width: 768px) {
            .menu-icon { display: block; }
            .header-tools { display: none; position: absolute; top: 60px; right: 20px; background: white; flex-direction: column; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
            .header-tools.open { display: flex; }
            .container { flex-direction: column; }
            .sidebar { width: auto; }
            .recipe-grid { grid-template-columns: 1fr; }
        }
        .btn-delete { background: none; color: var(--danger); border: 1px solid var(--danger); padding: 8px 15px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; margin-top: 20px; width: 100%; }
        .mode-switch { background: #eee; border-radius: 25px; padding: 4px; display: flex; }
        .mode-btn { border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; background: transparent; color: #777; }
        .mode-btn.active { background: var(--main-color); color: white; }
        .btn-load-ui { background: var(--sub-color); border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; color: #d35400; font-weight: bold; font-size: 0.85rem; }
        .btn-export-ui { background: #e0f2f1; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; color: #00796b; font-weight: bold; font-size: 0.85rem; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #f0f0f0; border-radius: 15px; box-sizing: border-box; margin-bottom: 10px; }
        .btn-primary { background: var(--main-color); color: white; border: none; padding: 15px; border-radius: 25px; cursor: pointer; font-weight: bold; width: 100%; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: white; width: 95%; max-width: 500px; border-radius: 30px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

<header class="app-header">
    <div class="app-title">ğŸ“ My Kitchen Studio</div>
    <div class="menu-icon" onclick="toggleMenu()">â˜°</div>
    <div class="header-tools" id="headerTools">
        <button class="btn-load-ui" onclick="document.getElementById('importFile').click()">ğŸ“‚ èª­è¾¼</button>
        <button class="btn-export-ui" onclick="exportData()">ğŸ’¾ ä¿å­˜</button>
        
        <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImport(this)">
        <div class="mode-switch">
            <button class="mode-btn active" id="view-tab" onclick="switchMode('view')">ğŸ“– è¦‹ã‚‹</button>
            <button class="mode-btn" id="build-tab" onclick="switchMode('build')">âœï¸ ä½œã‚‹</button>
        </div>
    </div>
</header>

<div id="viewPage" class="page active">
    <div class="container">
        <aside class="sidebar"><div id="palette"></div></aside>
        <main class="main-content">
            <input type="text" id="kwInput" class="search-input" placeholder="æ¤œç´¢..." oninput="update()">
            <div id="grid" class="recipe-grid"></div>
        </main>
    </div>
</div>

<div id="buildPage" class="page">
    <div style="background: white; padding: 25px; border-radius: 25px; max-width: 600px; margin: 0 auto;">
        <h2 style="color:var(--main-color); margin-top:0;">ğŸ“ æ–°è¦ç™»éŒ²</h2>
        <input type="text" id="recipeName" placeholder="æ–™ç†åï¼ˆä¾‹ï¼šè‚‰ã˜ã‚ƒãŒï¼‰">
        <div id="builderIngredientList">
            <p>2äººå‰</p>
            <div style="display:flex; gap:5px; margin-bottom:8px;">
                <select style="width:80px; margin:0;" class="b-ing-type"><option value="main">é£Ÿæ</option><option value="sub">èª¿å‘³æ–™</option></select>
                <input type="text" style="margin:0;" class="b-ing-name" placeholder="ææ–™" list="masterList">
                <input type="text" style="margin:0;" class="b-ing-amount" placeholder="åˆ†é‡">
            </div>
        </div>
        <button onclick="addBuilderRow()" style="background:none; border:2px dashed var(--sub-color); width:100%; padding:10px; border-radius:15px; color:var(--main-color); margin:10px 0; cursor:pointer;">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>
        <input type="url" id="recipeImg" placeholder="ç”»åƒURL">
        <select id="recipeCategory">
            <option value="ğŸ– ãŠè‚‰">ğŸ– ãŠè‚‰</option>
            <option value="ğŸŸ é­š">ğŸŸ é­š</option>
            <option value="ğŸ¥— é‡èœ">ğŸ¥— é‡èœ</option>
            <option value="ğŸ éººãƒ»ä¸»é£Ÿ">ğŸ éººãƒ»ä¸»é£Ÿ</option>
            <option value="ğŸ° ã‚¹ã‚¤ãƒ¼ãƒ„">ğŸ° ã‚¹ã‚¤ãƒ¼ãƒ„</option>
            <option value="âœ¨ ãã®ä»–">âœ¨ ãã®ä»–</option>
        </select>
        <input type="url" id="recipeUrl" placeholder="å‚è€ƒã‚µã‚¤ãƒˆURL"> 
        <textarea id="recipeMemo" rows="3" placeholder="ã‚³ãƒ„ãƒ»ãƒ¡ãƒ¢"></textarea>
        <button class="btn-primary" onclick="saveRecipe()">âœ¨ ç™»éŒ²ã—ã¦ä¿å­˜</button>
    </div>
</div>

<div id="modal" class="modal" onclick="closeModal()"><div class="modal-content" id="modalContent" onclick="event.stopPropagation()"></div></div>
<datalist id="masterList"></datalist>

<script>
    let recipes = JSON.parse(localStorage.getItem('myRecipes') || '[]');
    let masterItems = JSON.parse(localStorage.getItem('myMaster') || '{}');
    let selectedTags = new Set();

    window.onload = () => { renderPalette(); update(); updateDatalist(); };

    function toggleMenu() { document.getElementById('headerTools').classList.toggle('open'); }

    function switchMode(mode) {
        document.getElementById('viewPage').classList.toggle('active', mode === 'view');
        document.getElementById('buildPage').classList.toggle('active', mode === 'build');
        document.getElementById('view-tab').classList.toggle('active', mode === 'view');
        document.getElementById('build-tab').classList.toggle('active', mode === 'build');
        document.getElementById('headerTools').classList.remove('open');
    }

    // ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãå‡ºã—ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰
    function exportData() {
        if (recipes.length === 0 && Object.keys(masterItems).length === 0) {
            alert("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }
        // ãƒ¬ã‚·ãƒ”ã¨ãƒã‚¹ã‚¿ãƒ¼ä¸¡æ–¹ã‚’ä¿å­˜å¯¾è±¡ã«ã™ã‚‹
        const exportObj = {
            recipes: recipes,
            master: masterItems
        };
        const data = JSON.stringify(exportObj, null, 2);
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'my_recipes_backup.json';
        a.click();
        URL.revokeObjectURL(url);
    }

function update() {
    const kw = document.getElementById('kwInput').value.toLowerCase();
    
    // 1. æ¤œç´¢ã¨ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿
    const filtered = recipes.filter(r => {
        const mK = !kw || r.title.includes(kw) || r.ingredients.some(i => i.name.includes(kw));
        const mT = selectedTags.size === 0 || Array.from(selectedTags).every(t => r.ingredients.some(i => i.name.includes(t)));
        return mK && mT;
    });

    // 2. è¡¨ç¤ºç”¨ã«ã€Œæ–°ã—ã„é †ã€ã«ä¸¦ã³æ›¿ãˆ
    const displayList = [...filtered].reverse();

    // 3. ç”»é¢ï¼ˆã‚°ãƒªãƒƒãƒ‰ï¼‰ã«è¡¨ç¤º
    document.getElementById('grid').innerHTML = displayList.map((r) => `
        <div class="recipe-card" onclick="openModal(${recipes.indexOf(r)})">
            <div class="recipe-img-box">
                ${r.img ? `<img src="${r.img}">` : `<span style="font-size:1.8rem;">ğŸ³</span>`}
            </div>
            <div class="recipe-info">
                <div style="font-size:0.7rem; color:var(--main-color); margin-bottom:2px;">
                    ${r.category || 'âœ¨ ãã®ä»–'}
                </div>
                <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    ${r.title}
                </div>
            </div>
        </div>`).join('');
}

    function openModal(index) {
        const r = recipes[index];
        const mains = r.ingredients.filter(i => i.type === 'main');
        const subs = r.ingredients.filter(i => i.type === 'sub');

        document.getElementById('modalContent').innerHTML = `
            <div style="padding:20px;">
                <h2 style="color:var(--main-color); margin-top:0; margin-bottom:10px;">${r.title}</h2>
                <div style="width:100%; max-height:250px; overflow:hidden; border-radius:15px; margin-bottom:15px; background:#fdf2f2; display:flex; align-items:center; justify-content:center;">
                    ${r.img ? `<img src="${r.img}" style="width:100%; height:auto; object-fit:cover;">` : `<span style="font-size:3rem; padding:20px;">ğŸ³</span>`}
                </div>
                <p style="font-weight:bold; margin-bottom:10px;">2äººå‰</p>
                <div style="margin-bottom:15px;">
                    <strong>ğŸ›’ ææ–™</strong>
                    <ul style="padding-left:20px; margin-top:5px;">${mains.length ? mains.map(i=>`<li>${i.name}: ${i.amount}</li>`).join('') : '<li>ãªã—</li>'}</ul>
                </div>
                <div style="margin-bottom:20px;">
                    <strong>ğŸ§‚ èª¿å‘³æ–™</strong>
                    <ul style="padding-left:20px; margin-top:5px;">${subs.length ? subs.map(i=>`<li>${i.name}: ${i.amount}</li>`).join('') : '<li>ãªã—</li>'}</ul>
                </div>
                ${r.memo ? `<div style="background:#fff9db; padding:10px; border-radius:10px; margin-bottom:15px; font-size:0.9rem; white-space:pre-wrap;">${r.memo}</div>` : ''}
                ${r.url ? `<a href="${r.url}" target="_blank" style="display:block; text-align:center; margin-bottom:15px; color:var(--accent); text-decoration:none; font-weight:bold;">ğŸ”— ä½œã‚Šæ–¹ã‚’è¦‹ã‚‹</a>` : ''}
                <button class="btn-primary" onclick="closeModal()">é–‰ã˜ã‚‹</button>
                <button class="btn-delete" onclick="deleteRecipe(${index})">ğŸ—‘ï¸ ã“ã®ãƒ¬ã‚·ãƒ”ã‚’å‰Šé™¤ã™ã‚‹</button>
            </div>`;
        document.getElementById('modal').style.display = 'flex';
    }

    function deleteRecipe(index) {
        if(confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
            recipes.splice(index, 1);
            localStorage.setItem('myRecipes', JSON.stringify(recipes));
            closeModal(); update();
        }
    }

function saveRecipe() {
    const title = document.getElementById('recipeName').value;
    if(!title) return alert("æ–™ç†åã‚’å…¥ã‚Œã¦ã­");

    // è¿½åŠ ï¼šé¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
    const category = document.getElementById('recipeCategory').value;

    const names = document.querySelectorAll('.b-ing-name');
    const amounts = document.querySelectorAll('.b-ing-amount');
    const types = document.querySelectorAll('.b-ing-type');
    const ings = [];
    names.forEach((n, i) => { 
        if(n.value) ings.push({name: n.value, amount: amounts[i].value, type: types[i].value}); 
    });

    // recipes.push ã®ä¸­ã« ã€Œcategoryã€ ã‚’è¿½åŠ ã—ã¾ã—ãŸ
    recipes.push({ 
        title, 
        category, // â†ã“ã“ãŒè¿½åŠ ãƒã‚¤ãƒ³ãƒˆï¼
        img: document.getElementById('recipeImg').value, 
        url: document.getElementById('recipeUrl').value, 
        ingredients: ings, 
        memo: document.getElementById('recipeMemo').value 
    });

    localStorage.setItem('myRecipes', JSON.stringify(recipes));
    location.reload();
}

    function addBuilderRow() {
        const div = document.createElement('div'); div.style = "display:flex; gap:5px; margin-bottom:8px;";
        div.innerHTML = `<select style="width:80px; margin:0;" class="b-ing-type"><option value="main">é£Ÿæ</option><option value="sub">èª¿å‘³æ–™</option></select><input type="text" style="margin:0;" class="b-ing-name" placeholder="ææ–™" list="masterList"><input type="text" style="margin:0;" class="b-ing-amount" placeholder="åˆ†é‡">`;
        document.getElementById('builderIngredientList').appendChild(div);
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    
    function renderPalette() { 
        const p = document.getElementById('palette'); p.innerHTML = '';
        if (Object.keys(masterItems).length === 0) {
            p.innerHTML = '<p style="font-size:0.8rem; color:#999;">èª­è¾¼ãƒœã‚¿ãƒ³ã‹ã‚‰ææ–™ãƒã‚¹ã‚¿ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p>';
            return;
        }
        for (const [cat, items] of Object.entries(masterItems)) {
            const div = document.createElement('div');
            div.innerHTML = `<div class="cat-title">${cat}</div><div class="ing-tags"></div>`;
            items.forEach(item => {
                const span = document.createElement('span'); span.className = `ing-tag ${selectedTags.has(item) ? 'selected' : ''}`;
                span.textContent = item; span.onclick = () => { selectedTags.has(item) ? selectedTags.delete(item) : selectedTags.add(item); renderPalette(); update(); };
                div.querySelector('.ing-tags').appendChild(span);
            });
            p.appendChild(div);
        }
    }

    function handleImport(input) {
        const reader = new FileReader();
        reader.onload = () => {
            try {
                const data = JSON.parse(reader.result);
                // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå½¢å¼ã®åˆ¤åˆ¥ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã€å˜ä½“ãƒªã‚¹ãƒˆã‹ï¼‰
                if(data.recipes && data.master) {
                    recipes = data.recipes;
                    masterItems = data.master;
                } else if(Array.isArray(data)) {
                    recipes = data;
                } else {
                    masterItems = data;
                }
                localStorage.setItem('myRecipes', JSON.stringify(recipes));
                localStorage.setItem('myMaster', JSON.stringify(masterItems));
                alert("èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                location.reload();
            } catch(e) { alert("å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); }
        };
        reader.readAsText(input.files[0]);
    }

    function updateDatalist() {
        document.getElementById('masterList').innerHTML = Object.values(masterItems).flat().map(i => `<option value="${i}">`).join('');
    }
</script>
</body>
</html>